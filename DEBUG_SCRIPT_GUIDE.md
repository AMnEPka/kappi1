# Руководство по отладке скриптов-обработчиков

## Проблема
Скрипт работает локально, но не работает через приложение (exit code 162).

## Что было исправлено

### 1. Нормализация переводов строк (CRLF → LF)
- Скрипты, созданные на Windows, могут содержать CRLF (`\r\n`)
- Bash на Linux ожидает LF (`\n`)
- Теперь все переводы строк нормализуются перед выполнением

### 2. Улучшенное логирование
- Логируется превью скрипта (первые 20 строк)
- Логируются размеры всех данных
- Логируется информация о exit code
- Логируется содержимое STDERR

### 3. Отладочные скрипты
Созданы две версии отладочных скриптов:

#### `debug_script.sh` - Полная версия
Выводит всю отладочную информацию в STDERR, чтобы не мешать основному выводу.

**Использование:**
```bash
export CHECK_OUTPUT="[sssd]
config_version=2
services = pam

[domain/ad.example.com]
auth_provider = ad

#simple_allow_users = user1,user2,user3
simple_allow_groups = group1,group1,group3"

export ETALON_INPUT="user1
user2"

bash debug_script.sh
```

#### `debug_script_simple.sh` - Упрощенная версия
Выводит всю информацию в STDOUT для быстрого просмотра.

**Использование:**
```bash
export CHECK_OUTPUT="..."
export ETALON_INPUT="..."
bash debug_script_simple.sh
```

## Как использовать отладочные скрипты в приложении

1. Скопируйте содержимое `debug_script.sh` или `debug_script_simple.sh`
2. Вставьте в поле "Скрипт-обработчик" в интерфейсе приложения
3. Запустите проверку
4. Проверьте логи в `logs/ssh_operations.log`

## Что смотреть в логах

После улучшений логирования вы увидите:

```
>>> PROCESSOR SCRIPT (preview):
#!/usr/bin/env bash
set -euo pipefail
...

>>> INPUT DATA (CHECK_OUTPUT) - 123 chars, 10 lines:
[sssd]
...

>>> REFERENCE DATA (ETALON_INPUT) - 8 chars, 2 lines:
user1
user2

>>> EXIT CODE: 162 (Script error)

>>> STDOUT (0 chars):
(empty)

>>> STDERR (0 chars):
(empty)
```

## Возможные причины exit code 162

Exit code 162 может означать:
- Проблема с синтаксисом bash скрипта
- Проблема с кодировкой символов
- Проблема с переменными окружения
- Bash не может выполнить скрипт по какой-то причине

## Отладка через логи приложения

В логах приложения (не в ssh_operations.log) теперь выводится:
- Превью скрипта (первые 500 символов)
- Размеры всех данных
- Первые 3 строки скрипта
- Размеры переменных окружения
- Детальная информация о STDOUT/STDERR

## Исправление регулярного выражения

**Важно:** Убедитесь, что в вашем скрипте используется правильное регулярное выражение:

```bash
# ПРАВИЛЬНО (игнорирует закомментированные строки):
line="$(echo "$CHECK_OUTPUT" | grep -E '^[[:space:]]*[^#[:space:]]simple_allow_users[[:space:]]*=' || true)"

# НЕПРАВИЛЬНО (найдет закомментированную строку):
line="$(echo "$CHECK_OUTPUT" | grep -E '^[[:space:]]*simple_allow_users[[:space:]]*=' || true)"
```

## Следующие шаги

1. Запустите проверку с улучшенным логированием
2. Проверьте логи - теперь там будет больше информации
3. Если проблема сохраняется, используйте отладочный скрипт
4. Проверьте, что регулярное выражение правильное
