# КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ

## Проблема
Exit code 162 вместо ожидаемого 4002. Скрипт доходит до `exit 4002`, но возвращается код 162.

## Причины

### 1. Неправильное регулярное выражение
**В вашем скрипте все еще используется:**
```bash
line="$(echo "$CHECK_OUTPUT" | grep -E '^[[:space:]]*[^#]simple_allow_users[[:space:]]*=' || true)"
```

**Проблема:** `[^#]` требует символ перед `simple_allow_users`, что неправильно.

**Исправление:** Используйте `[^#[:space:]]`:
```bash
line="$(echo "$CHECK_OUTPUT" | grep -E '^[[:space:]]*[^#[:space:]]simple_allow_users[[:space:]]*=' || true)"
```

### 2. Проблема с `set -u`
`set -u` может вызывать проблемы с переменными окружения, особенно с многострочными значениями.

**Исправление:** Используйте `set -eo pipefail` вместо `set -euo pipefail`

### 3. Проблема с проверкой переменных
Многострочные переменные могут неправильно обрабатываться в `[[ -z ... ]]`.

**Исправление:** Используйте `[ -z ... ]` вместо `[[ -z ... ]]` для более безопасной обработки.

## ФИНАЛЬНЫЙ ИСПРАВЛЕННЫЙ СКРИПТ

Скопируйте содержимое файла `FINAL_FIXED_SCRIPT.sh` в поле "Скрипт-обработчик":

```bash
#!/usr/bin/env bash
set -eo pipefail  # Убрали -u

if [ -z "${CHECK_OUTPUT:-}" ]; then
    exit 5001
fi

if [ -z "${ETALON_INPUT:-}" ]; then
    exit 5001
fi

# ИСПРАВЛЕНО: правильное регулярное выражение
line="$(echo "$CHECK_OUTPUT" | grep -E '^[[:space:]]*[^#[:space:]]simple_allow_users[[:space:]]*=' || true)"

if [[ -z "$line" ]]; then
    if echo "$CHECK_OUTPUT" | grep -qE '^[[:space:]]*#.*simple_allow_users'; then
        exit 4002
    fi
    exit 4001
fi

actual="$(echo "$line" | sed 's/^[^=]*=//' | tr -d ' ')"
expected="$(echo "$ETALON_INPUT" | tr -d ' ')"

echo "ACTUAL_DATA: $actual"

if [[ "$actual" == "$expected" ]]; then
    echo "Пройдена"
    exit 0
else
    exit 4004
fi
```

## Что изменилось

1. ✅ `set -euo pipefail` → `set -eo pipefail` (убрали `-u`)
2. ✅ `[[ -z ... ]]` → `[ -z ... ]` (для проверки переменных)
3. ✅ `[^#]` → `[^#[:space:]]` (правильное регулярное выражение)

## После применения

После замены скрипта на исправленную версию:
- Скрипт должен правильно определять закомментированные строки
- Exit code должен быть правильным (4002 для закомментированной строки)
- Не должно быть проблем с многострочными переменными
