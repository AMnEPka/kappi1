#!/usr/bin/env bash

set -eo pipefail  

# CHECK_OUTPUT может быть пустым, если группа не найдена - это нормально
# Не проверяем на обязательность переменной, так как пустой вывод = группа не найдена = успех

# Парсим вывод getent group wheel
# Формат getent group wheel: groupname:password:gid:members
# Примеры:
#   wheel:x:10:          - группа без пользователей (пустое поле members)
#   wheel:x:10:user1     - группа с одним пользователем
#   wheel:x:10:user1,user2 - группа с несколькими пользователями

# Проверяем, что группа найдена (вывод не пустой)
if [[ -z "${CHECK_OUTPUT:-}" ]] || [[ "$CHECK_OUTPUT" =~ ^[[:space:]]*$ ]]; then
    # Группа не существует - проверка пройдена
    echo "Пройдена"
    exit 0
fi

# Извлекаем последнее поле после последнего двоеточия (список пользователей)
members="$(echo "$CHECK_OUTPUT" | awk -F':' '{print $NF}' | tr -d '[:space:]')"

# Проверяем, пусто ли поле members (группа не содержит пользователей)
if [[ -z "$members" ]]; then
    # Группа не содержит пользователей - проверка пройдена
    echo "Пройдена"
    exit 0
else
    # Группа содержит пользователей - проверка не пройдена
    echo "DEBUG: группа содержит пользователей: $members"
    exit 44 # Неверное значение → "Не пройдена"
fi
