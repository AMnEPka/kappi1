FROM python:3.11-slim

RUN apt-get update && apt-get install -y \
    gcc-12 g++-12 \
    libnuma-dev \
    git \
    && rm -rf /var/lib/apt/lists/* \
    && update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 10 \
    --slave /usr/bin/g++ g++ /usr/bin/g++-12

RUN pip install --upgrade pip wheel setuptools ninja "packaging"

# Установите PyTorch CPU версию СНАЧАЛА
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Потом установите vLLM с CPU поддержкой
# Используйте опцию --no-build-isolation чтобы избежать конфликтов
RUN pip install vllm \
    --no-build-isolation \
    -v \
    --extra-index-url https://download.pytorch.org/whl/cpu

WORKDIR /app
EXPOSE 8000

CMD ["python3", "-m", "vllm.entrypoints.openai.api_server"]
